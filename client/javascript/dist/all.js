function dragLeave(e,t){e.style.opacity=1}function dragOver(e,t){e.style.opacity=.3,t.preventDefault()}function dragStart(e,t){dragSource=e,t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/html",e.innerHTML)}function dragDrop(e,t){if(e.style.opacity=1,t.stopPropogation&&t.stopPropogation(),dragSource!=e){var o=dragSource.id;dragSource.innerHTML=e.innerHTML,dragSource.id=e.id,e.id=o,e.innerHTML=t.dataTransfer.getData("text/html")}return!1}function deleteBlock(e){var t="";_.forEach(document.getElementById("viewEditor").childNodes,function(o){o.id!==e&&(t+="{{-"+o.id+"}}\n")}),angular.element($("#viewEditor")).scope().deleteBlock(t)}var app=angular.module("dash",["ui.router","ngCookies","ngMaterial"]);app.config(["$stateProvider","$urlRouterProvider","$mdThemingProvider",function(e,t,o){o.definePalette("yeti",{50:"f8f8f8",100:"333333",200:"0d47a1",300:"0d47a1",400:"0d47a1",500:"0d47a1",600:"0d47a1",700:"0d47a1",800:"0d47a1",900:"0d47a1",A100:"0d47a1",A200:"0d47a1",A400:"0d47a1",A700:"0d47a1",contrastDefaultColor:"light"}),o.theme("default").primaryPalette("blue",{"default":"800"}).accentPalette("yeti",{"default":"500","hue-1":"50","hue-2":"100"}),t.otherwise("/"),e.state("home",{url:"/",templateUrl:"/javascript/app/admin/admin.html",controller:"adminController"}).state("users",{url:"/users",templateUrl:"/javascript/app/users/users.html",controller:"userController"}).state("login",{url:"/login",templateUrl:"/javascript/app/login/login.html",controller:"loginController"}).state("changepass",{url:"/changepass",templateUrl:"/javascript/app/changepass/changepass.html",controller:"changepassController"}).state("firstRun",{url:"/firstRun",templateUrl:"/javascript/app/firstRun/firstRun.html",controller:"firstRunController"}).state("viewsDefault",{url:"/views",templateUrl:"/javascript/app/views/views.html",controller:"viewsController"}).state("views",{url:"/views/:viewId/:viewRevision",views:{"":{templateUrl:"/javascript/app/views/views.html",controller:"viewsController"},"editView@views":{templateUrl:"/javascript/app/editView/editView.html",controller:"editViewController"}}}).state("blocksDefault",{url:"/blocks",templateUrl:"/javascript/app/blocks/blocks.html",controller:"blocksController"}).state("blocks",{url:"/blocks/:blockId/:blockRevision",views:{"":{templateUrl:"/javascript/app/blocks/blocks.html",controller:"blocksController"},"editBlock@blocks":{templateUrl:"/javascript/app/editBlock/editBlock.html",controller:"editBlockController"}}}).state("postsDefault",{url:"/posts",templateUrl:"/javascript/app/posts/posts.html",controller:"postsController"}).state("posts",{url:"/posts/:postId/:postRevision",views:{"":{templateUrl:"/javascript/app/posts/posts.html",controller:"postsController"},"editPost@posts":{templateUrl:"/javascript/app/editPost/editPost.html",controller:"editPostController"}}}).state("css",{url:"/css",templateUrl:"/javascript/app/css/css.html",controller:"cssController"}).state("gallery",{url:"/gallery",templateUrl:"/javascript/app/gallery/gallery.html",controller:"galleryController"})}]).run(["$rootScope","$state",function(e,t){e.$on("$stateChangeSuccess",function(o,n,r,i){t.previous=i,e.current=n.name})}]);try{Typekit.load()}catch(e){}$(document).ready(function(){$('section[data-type="background"]').each(function(){var e=$(this);$(window).scroll(function(){function t(e){for(var t=0,o=0;null!=e;t+=e.offsetLeft,o+=e.offsetTop,e=e.offsetParent);return{x:t,y:o}}var o=-($(window).scrollTop()/e.data("speed")),n="50% "+o+"px",r=window.innerHeight+document.body.scrollTop;e.css({backgroundPosition:n}),$(".hiddenItem").each(function(){var e=t(this).y;r>e+200&&$(this).animate({opacity:"1"},1e3)}),r>20?$("#arrow").css({opacity:0}):$("#arrow").css({opacity:100})})})}),document.createElement("section"),app.controller("adminController",["$rootScope","$scope","$state","viewService",function(e,t,o,n){e.isLoading=!1,t.$on("$viewContentLoaded",function(){t.refreshAuth()["catch"](function(){o.go("login")})}),t.$on("$stateChangeSuccess",function(){n.getViews().then(function(e){t.views=e})})}]),app.controller("blocksController",["$rootScope","$scope","$state","$http","$mdDialog","loaderService",function(e,t,o,n,r,i){t.blocks=[],t.currentBlockId=window.location.hash.split("/")[2],t.$on("$stateChangeSuccess",function(e,o){("blocksDefault"===o.name||"blocks"===o.name)&&(i.show(),n.get("/api/blocks").then(function(e){_.each(e.data,function(e,o){t.blocks.push({id:e._id,index:o,title:e.title,revisions:e.revisions.length})}),"#/blocks"===window.location.hash&&window.location.assign("/admin/#/blocks/"+t.blocks[0].id+"/"+t.blocks[0].revisions),i.hide()})["catch"](function(e){console.log(e)}))}),t.addBlock=function(){n({method:"POST",url:"/api/blocks/addBlock",data:{blockType:t.blockType,blockName:t.blockName}}).then(function(e){r.hide(),e&&e.data._id&&e.data.revisions&&200===e.status&&window.location.assign("/admin/#/blocks/"+e.data._id+"/"+e.data.revisions.length)})["catch"](function(e){console.log(e)})},t.showConfirm=function(e){r.show({templateUrl:"/javascript/app/blocks/addBlockModal.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0})}}]),app.controller("cssController",["$rootScope","$scope","$state","$stateParams","$http","loaderService",function(e,t,o,n,r,i){t.options={allowedContent:!0,extraPlugins:"save"},editAreaLoader.init({id:"cssEditor",syntax:"css",start_highlight:!0,min_width:1240,min_height:650,allow_toggle:!1,allow_resize:!0}),t.$on("$stateChangeSuccess",function(e,t){"css"===t.name&&(i.show(),r({method:"GET",url:"/api/settings"}).success(function(e){editAreaLoader.setValue("cssEditor",e.user_stylesheet),i.hide()}).error(function(e){throw new Error(e)}))}),t.saveCss=function(){r({method:"POST",url:"/api/settings/css",data:{user_stylesheet:editAreaLoader.getValue("cssEditor")}}).success(function(e){204===e&&location.reload()}).error(function(e){throw new Error(e)})}}]),app.controller("changepassController",["$rootScope","$scope","$state",function(e,t,o){t.passSubmit=function(){t.passwordError={},t.changePass(e.user.name,t.oldPassword,t.newPassword).then(function(){o.go(o.previous.name)})["catch"](function(e){t.passwordError.message=e.data})}}]),app.directive("userBar",function(){return{templateUrl:"/javascript/app/directives/userBar.html"}}),app.controller("editBlockController",["$rootScope","$scope","$state","$stateParams","$http","$sce","$mdToast",function(e,t,o,n,r,i,a){var s=$("div#editor");t.saveBlock=function(){var e={blockId:n.blockId};t.isBlog?(e.numPosts=t.blockSettings.numToDisplay,e.displayTitles=t.blockSettings.displayTitles,e.displayedCategories=t.blockSettings.displayedCategories):(e.blockContent=s.froalaEditor("html.get"),e.blockRevision=n.blockRevision),r({method:"POST",url:"/api/blocks",data:e}).success(function(e){204===e&&(o.go(o.current,{},{reload:!0}),a.show(a.simple().content("Block Saved!").position("top right").hideDelay(3e3)))}).error(function(e){throw new Error(e)})},t.deleteBlock=function(){r({method:"POST",url:"/api/blocks/deleteBlock",data:{blockId:n.blockId}}).success(function(e){e&&o.go("blocksDefault")}).error(function(e){throw new Error(e)})},t.$on("$stateChangeSuccess",function(){n.blockId&&r.get("/api/blocks/"+n.blockId).then(function(e){"blog"===e.data.type?(t.blockSettings={numToDisplay:e.data.numPosts,displayTitles:e.data.displayTitles,displayedCategories:e.data.displayedCategories||[]},t.blockDetails=e.data,t.isBlog=!0):(t.isBlog=!1,s.froalaEditor({toolbarButtons:["fullscreen","bold","italic","underline","strikeThrough","subscript","superscript","fontFamily","fontSize","|","color","emoticons","inlineStyle","paragraphStyle","|","paragraphFormat","align","formatOL","formatUL","outdent","indent","-","insertLink","insertImage","insertVideo","insertFile","insertTable","|","quote","insertHR","undo","redo","clearFormatting","selectAll","html"]}),s.froalaEditor("html.set",e.data.body.content))}).then(function(){r.get("/api/posts/categories").then(function(e){t.postCategories=e.data})})["catch"](function(e){console.log(e)})}),t.toggle=function(e,t){var o=t.indexOf(e);o>-1?t.splice(o,1):t.push(e)},t.exists=function(e,t){return t.indexOf(e)>-1}}]),app.controller("editPostController",["$rootScope","$scope","$state","$stateParams","$http","$sce","$mdToast",function(e,t,o,n,r,i,a){var s=$("div#editor");t.savePost=function(){r({method:"POST",url:"/api/posts",data:{postId:n.postId,postContent:s.froalaEditor("html.get"),postRevision:n.postRevision,postCategory:t.postCategory}}).success(function(e){204===e&&(o.go(o.current,{},{reload:!0}),a.show(a.simple().content("Post Saved!").position("top right").hideDelay(3e3)))}).error(function(e){throw new Error(e)})},t.deletePost=function(){r({method:"POST",url:"/api/posts/deletePost",data:{postId:n.postId}}).success(function(e){e&&o.go("postsDefault")}).error(function(e){throw new Error(e)})},t.$on("$stateChangeSuccess",function(){n.postId&&r.get("/api/posts/"+n.postId).then(function(e){t.postCategory=e.data.postCategory,s.froalaEditor({codeBeautifier:!0,codeMirror:!0,toolbarButtons:["fullscreen","bold","italic","underline","strikeThrough","subscript","superscript","fontFamily","fontSize","|","color","emoticons","inlineStyle","paragraphStyle","|","paragraphFormat","align","formatOL","formatUL","outdent","indent","-","insertLink","insertImage","insertVideo","insertFile","insertTable","|","quote","insertHR","undo","redo","clearFormatting","selectAll","html"],imageManagerLoadURL:"http://localhost:3000/api/media/editorList"}),s.froalaEditor("html.set",e.data.body.content)})["catch"](function(e){console.log(e)})})}]),app.controller("editViewController",["$rootScope","$scope","$state","$stateParams","viewService","$http","$sce","$q","$mdToast",function(e,t,o,n,r,i,a,s,c){function l(){if(n.viewId){r.setSelectedViewId(n.viewId);var e=r.getViewById(n.viewId);t.viewRoute=e.route,~e.content.indexOf("{{")?d(e.content).then(function(e){t.editorContent=a.trustAsHtml(e)})["catch"](function(e){console.log(e)}):t.editorContent=a.trustAsHtml(e.content),t.blocks=[],i.get("/api/blocks").then(function(e){_.each(e.data,function(e,o){t.blocks.push({id:e._id,index:o,title:e.title,revisions:e.revisions.length})})})["catch"](function(e){console.log(e)})}}function d(e){var t=s.defer(),o="",n=[],r=e.split(/\n/);return _.forEach(r,function(e){var t=/{{-([\s\S]*?)}}/g.exec(e)[1];n.push(i.get("/api/blocks/"+t))}),s.all(n).then(function(e){_.forEach(e,function(e){o+='<div id="'+e.data.parentId+'"class="blockContent" draggable="true"onDragStart="dragStart(this, event)"onDrop="dragDrop(this, event)"onDragOver="dragOver(this, event)"onDragLeave="dragLeave(this, event)">'+e.data.body.content+'<div class="blockControlBox"><a href="/admin/#/blocks/'+e.data.parentId+"/"+e.data.revision+'"><i class="btn fa fa-pencil fa-4x""></i></a><i class="btn fa fa-trash-o fa-4x" onclick="deleteBlock(\''+e.data.parentId+"')\"></i></div></div>"}),t.resolve(o)}),t.promise}function u(){var e="";return _.forEach(document.getElementById("viewEditor").childNodes,function(t){t.id&&(e+="{{-"+t.id+"}}\n")}),e}function p(e){i({method:"POST",url:"/api/views",data:{viewId:n.viewId,viewContent:e.replace(/\n$/,""),viewRoute:t.viewRoute,viewRevision:n.viewRevision}}).success(function(e){204===e&&r.setViews().then(function(){o.go(o.current,{},{reload:!0}),c.show(c.simple().content("View Saved!").position("top right").hideDelay(3e3))})}).error(function(e){throw new Error(e)})}t.selectedBlock="",t.saveView=function(){p(u())},t.$on("$stateChangeSuccess",function(){r.getViews().then(function(e){t.defaultViewId=r.getDefaultView().id,t.views=e,l()})}),t.makeDefault=function(){i({method:"POST",url:"/api/settings/defaultHome",data:{viewId:n.viewId}}).success(function(e){204===e&&r.setViews().then(function(){o.go(o.current,{},{reload:!0}),c.show(c.simple().content("View is now default!").position("top right").hideDelay(3e3))})}).error(function(e){throw new Error(e)})},t.deleteView=function(){i({method:"POST",url:"/api/views/deleteView",data:{viewId:n.viewId}}).success(function(e){e&&r.setViews().then(function(){o.go("viewsDefault",{},{reload:!0})})}).error(function(e){throw new Error(e)})},t.addBlock=function(){p(u()+"{{-"+t.selectedBlock+"}}"),l()},t.deleteBlock=function(e){p(e),l()}}]);var dragSource;app.controller("galleryController",["$rootScope","$scope","$state","$http","loaderService",function(e,t,o,n,r){t.$on("$stateChangeSuccess",function(e,o){"gallery"===o.name&&(r.show(),t.getMedia())}),t.getMedia=function(){n({method:"GET",url:"/api/media"}).success(function(e){t.mediaList=e,r.hide()}).error(function(e){throw new Error(e)})},t.submitImage=function(){var e=document.getElementById("inputFile").files[0],t=new FileReader;t.onloadend=function(t){var o=t.target.result;n({method:"POST",url:"/api/media",data:{file_name:e.name,media_data:o}}).success(function(e){204===e&&location.reload()}).error(function(e){throw new Error(e)})},t.readAsBinaryString(e)},t.displayImage=function(e){var t=e.split(".").pop();return("svg"===t?"/images/":"/images/thumbs/thumb_")+e}}]),app.controller("homeController",["$rootScope","$scope","$state","$cookies",function(e,t,o,n){}]),app.controller("loginController",["$rootScope","$scope","$state",function(e,t,o){t.loginSubmit=function(){t.loginError={},t.verifyUser(t.inputUser,t.inputPassword).then(function(e){e.data.success?(delete t.loginError.message,t.setToken(t.inputUser,e.data.token),o.go(o.previous.name||"home")):t.loginError.message="Username and/or password incorrect."})["catch"](function(e){t.loginError.message=e.data})}}]),app.factory("loaderService",["$rootScope","$timeout",function(e,t){var o,n={},r=300;return n.show=function(){o=!0,t(function(){o&&(e.isLoading=!0,o=!0)},r)},n.hide=function(){o=!1,e.isLoading=!1},n}]),app.factory("viewService",["$q","$http",function(e,t){function o(){return t.get("/api/views/edit").then(function(e){return n=e.data})["catch"](function(e){console.log(e)})}var n,r,i={};return i.setSelectedViewId=function(e){r=e},i.getSelectedViewId=function(){return r},i.setViews=function(){return o()},i.getViews=function(){return n?e.when(n):o().then(function(e){return n})},i.getViewById=function(e){return _.find(n,{id:e})},i.getDefaultView=function(){return _.find(n,{defaultView:!0})},i}]),app.controller("postsController",["$rootScope","$scope","$state","$http","$mdDialog","$cookies","loaderService",function(e,t,o,n,r,i,a){t.posts=[],t.currentPostId=window.location.hash.split("/")[2],t.$on("$stateChangeSuccess",function(e,o){("postsDefault"===o.name||"posts"===o.name)&&(a.show(),n.get("/api/posts").then(function(e){_.each(e.data,function(e,o){t.posts.push({id:e._id,index:o,title:e.title,revisions:e.revisions.length})}),"#/posts"===window.location.hash&&window.location.assign("/admin/#/posts/"+t.posts[0].id+"/"+t.posts[0].revisions),a.hide()})["catch"](function(e){console.log(e)}))}),t.addPost=function(){n({method:"POST",url:"/api/users/verifytoken",data:{token:i.get("authToken")}}).success(function(e){n({method:"POST",url:"/api/posts/addPost",data:{postName:t.postName,author:e.decoded.userId}}).then(function(e){r.hide(),e&&e.data._id&&e.data.revisions&&200===e.status&&window.location.assign("/admin/#/posts/"+e.data._id+"/"+e.data.revisions.length)})["catch"](function(e){console.log(e)})})},t.showConfirm=function(e){r.show({templateUrl:"/javascript/app/posts/addPostModal.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0})}}]),app.controller("userController",["$rootScope","$scope","$q","$http","$state","$cookies","$mdDialog","loaderService",function(e,t,o,n,r,i,a,s){function c(){return n.get("/api/users").then(function(e){return e})["catch"](function(e){return e})}t.$on("$stateChangeSuccess",function(e,o){"users"===o.name&&(s.show(),c().then(function(e){t.userList=e.data,s.hide()})["catch"](function(e){console.log(e)}))}),t.verifyUser=function(e,t){return n({method:"POST",url:"/api/users/verify",data:{username:e,password:t}}).success(function(e){return e}).error(function(e){return e})},t.verifyToken=function(e){return n({method:"POST",url:"/api/users/verifytoken",data:{token:e}}).success(function(e){return e}).error(function(e){return e})},t.logout=function(){i.remove("authToken"),r.go("login")},t.changePass=function(e,t,o){return n({method:"POST",url:"/api/users/changepass",data:{username:e,oldpassword:t,newpassword:o}}).success(function(e){return e}).error(function(e){return e})},t.setToken=function(t,o){i.put("authToken",o),e.verified=!0,e.user={name:t}},t.refreshAuth=function(){var n=o.defer(),r=i.get("authToken");return t.verifyToken(r).then(function(t){200===t.status?(e.verified=!0,e.user={name:t.data.decoded.userName},n.resolve(!0)):n.reject(401)})["catch"](function(e){n.reject(e)}),n.promise},t.refreshAuth()["catch"](function(){r.go("login")}),t.userSubmit=function(){n({method:"POST",url:"/api/users/register",data:{firstRun:!0,username:t.inputUsername,password:t.inputPassword,email:t.inputEmail}}).success(function(e){t.verifyUser(t.inputUsername,t.inputPassword).then(function(e){e.data.success&&(a.hide(),r.go(r.current,{},{reload:!0}))})}).error(function(e){throw new Error(e)})},t.deleteUser=function(e,t){var o=a.confirm().title("Are you sure you want to delete this user?").content("This cannot be reversed!").targetEvent(e).ok("Delete").cancel("Cancel");a.show(o).then(function(){n({method:"POST",url:"/api/users/delete/"+t}).success(function(){r.go(r.current,{},{reload:!0})}).error(function(e){throw new Error(e)})},function(){})},t.showConfirm=function(e){a.show({templateUrl:"/javascript/app/users/addUserModal.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0})}}]),app.controller("viewsController",["$rootScope","viewService","$scope","$state","$http","$mdDialog","loaderService",function(e,t,o,n,r,i,a){o.currentViewId=window.location.hash.split("/")[2],o.$on("$stateChangeSuccess",function(e,n){("viewsDefault"===n.name||"views"===n.name)&&(a.show(),t.getViews().then(function(e){o.views=e;var n=t.getDefaultView();"#/views"===window.location.hash&&n&&window.location.assign("/admin/#/views/"+n.id+"/"+n.revisions),a.hide()}))}),o.addView=function(){r({method:"POST",url:"/api/views/addView",data:{viewName:o.viewName}}).then(function(e){i.hide(),e&&e.data._id&&e.data.revisions&&200===e.status&&t.setViews().then(function(){window.location.assign("/admin/#/views/"+e.data._id+"/"+e.data.revisions.length)})})["catch"](function(e){console.log(e)})},o.showConfirm=function(e){i.show({templateUrl:"/javascript/app/views/addViewModal.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0})}}]);